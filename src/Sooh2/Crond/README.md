# 定时任务系统

## 1.设计目标

1. 增删改定时任务时间时，不再需要改crontab文件，直接改php文件即可(crontab里固定一条记录)
2. 记录定时任务执行情况
3. 可以指定某一批定时任务被执行的顺序

实现逻辑是：启动后，检查目录下所有任务类，fork进程去运行任务：

- Standalone子目录下的任务会被独立fork进程执行
- 其他子目录下，根据设置的顺序依次执行(这里只是帮着确定的同一个子目录下任务的调用顺序，不保障前面的任务能正常执行结束)

每个fork的进程，每分钟检查一下进程内分配的任务类的设置，根据情况是否调用任务类onRun方法，并将执行结果记录下来。

注意：

1. 定时任务管理器每小时启动一次，每次执行一小时，启动负载在那里，所以，每小时整点的执行一般会有些许滞后
2. 每个定时任务执行时间最小间隔是1分钟
3. 搜索定时任务时，只会搜索一层子目录，不会搜索更深的层次
4. ，
5. 当任务繁重的时候，调用间隔可能会出现误差，不能严丝合缝的在准确的秒内执行

## 2.使用方式

### 2.1 创建任务类

        class CheckOrders extends \Sooh2\Crond\Task
        {
            public function init()
            {
                parent::init(); // TODO: Change the autogenerated stub
                $this->toBeContinue = false;//只执行一次，类似配置说明，参看3.3
                $this->ret = new \Sooh2\Crond\Ret();
            }

            public function free()
            {
                parent::free(); // TODO: Change the autogenerated stub
            }

            /**
             * 执行任务内容，最后要设置任务执行结果描述，返回本次执行是否算正常结束
             * @param \Sooh2\Crond\Time $dt
             * @return boolean
             */
            public function onRun($dt)
            {
                if($this->_isManual || $dt->hour == 3){//如果是手动执行或是凌晨三点
                    "dosth..."
                    $this->lastMsg = $this->ret->toString('任务成功完成');
                }else{
                    $this->lastMsg = $this->ret->toString('时间不对，跳过');
                }
                return true;
            }
        }

### 2.2 设置启动任务

根据具体开发框架，创建两个入口（一个crontab自动执行用的，一个手动执行用的），然后在crontab里设置每个小时0分0秒时启动

    public function hourlyAction()
    {
        $ctrl = \Sooh2\Crond\Ctrl::factory(false)
                ->initCrondDir(realpath(__DIR__.'/../..')."/application/Cronds")   //设置定时任务的搜索目录
                ->initNamespace('PrjCronds')                                        //设置定时任务使用的命名空间
                ->initCmdTpl("php /usr/local/openresty/nginx/html/php/console/run.php \"request_uri=/console/hourly?task={task}&ymdh={ymdh}\"") 设置命令行模板
                ->initLoger(\Sooh2\Crond\CrondLog::getCopy(null)->disableTraceLog())//设置记录执行日志的类(关闭追踪日志)
                ;
        $ctrl->runCrond($this->_request->get('task'), $this->_request->get('ymdh'));//注意request获取task参数和ymdh参数
    }

    public function manualAction()
    {
        $ctrl = \Sooh2\Crond\Ctrl::factory(false)
                ->initCrondDir(realpath(__DIR__.'/../..')."/application/Cronds")//设置定时任务的搜索目录
                ->initNamespace('PrjCronds')                                    //设置定时任务使用的命名空间
                ->initLoger(\Sooh2\Crond\CrondLog::getCopy(null))               //设置记录执行日志的类
                ;
        $ctrl->runManually($this->_request->get('task'), $this->_request->get('ymdh'));//注意request获取task参数和ymdh参数
    }

默认的记录日志的类是 KVObj 的 子类，相关配置参看 [KVObj的说明](../DB/KVOBJ.md)

## 3 补充说明

### 3.1 依赖 

- \Sooh2\DB\KVObj （如果使用了默认的记录日志类）

### 3.2 重点系统类&变量 

| 类名              | 说明
| ----------------  | ---------------------------------------------------------
| Task类            | 任务类，注意里面各种设置
| Ctrl类            | 调用执行逻辑实现
| Ret类             | 提供了一个简单的合成执行任务结果描述的辅助类（成功多少，失败多少等等）
| Time类            | 记录本轮开始执行定时任务的时间（不是服务器当前时间）
| CrondLog类        | 记录入库的类（可以换成你自己的）

### 3.3 重点函数说明 

任务类工作模式使用了类属性的方式设置，根据情况在init方法中设置：

        $this->_secondsRunAgain=30;  //两次调用间的间隔秒数（默认30，调用间隔不总是保证60秒）
        $this->_iissStartAfter=0; //首次运行的时间点，比如要在每个小时的第6分钟后开始运行，这里设置成500
        $this->_toBeContinue=false;//每次执行后检查，如果false，释放该任务类，否则等待下次调用，init和onRun里设置均可

具体任务执行函数 onRun，可以根据现场环境具体区分执行，最后总要设置lastMsg,并返回bool作为执行是否算成功


### 3.4 默认提供的类需要的相关配置 sql

        CREATE TABLE `tb_crondlog_0` (
          `ymdh` bigint(20) NOT NULL,
          `taskid` varchar(64) NOT NULL COMMENT '定时任务',
          `lastStatus` varchar(2000) NOT NULL COMMENT '最后执行结果',
          `lastRet` tinyint(4) NOT NULL COMMENT '0: 未正常结束   1：正常结束',
          `isManual` tinyint(4) NOT NULL DEFAULT '0' COMMENT '0:自动   1:手动',
          `theminute` tinyint(4) NOT NULL COMMENT '分钟',
          `thesecond` tinyint(4) NOT NULL COMMENT '秒',
          `rowVersion` bigint(20) NOT NULL DEFAULT '0',
          PRIMARY KEY (`ymdh`,`taskid`)
        ) COMMENT '定时任务执行情况';
